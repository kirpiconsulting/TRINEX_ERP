@model List<erpv01.Controllers.UretimController.UretimListeDto>

@{
    ViewData["Title"] = "Üretim İş Emirleri";
    Layout = "_Layout";
}

<div class="container-fluid mt-3 mb-3">

    <!-- TOOLBAR -->
    <div class="row mb-2">
        <div class="col-12">
            <div id="listeToolbar"></div>
        </div>
    </div>

    <!-- GRID -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div id="uretimGrid" style="height: calc(100vh - 180px); width: 100%;"></div>
        </div>
    </div>
</div>


@section Scripts {

<script>
document.addEventListener("DOMContentLoaded", function () {

    // ----------------------------------
    // 1) TOOLBAR (Satıştaki AYNI sistem)
    // ----------------------------------
    liste_ekrani_butonlari_olustur("listeToolbar", {
        fonksiyonlar: [
            { ad: "Üretime Gönder", action: "uretime_gonder" }
        ],
        ciktilar: [
            { ad: "PDF Yazdır", action: "uretim_pdf" }
        ]
    });

    // ----------------------------------
    // 2) MODELDEN GERÇEK DATA (camelCase)
    // ----------------------------------
    var tabloVerileri = @Html.Raw(
        System.Text.Json.JsonSerializer.Serialize(
            Model,
            new System.Text.Json.JsonSerializerOptions {
                PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
            }
        )
    );

    console.log("Üretim Data:", tabloVerileri);

    // ----------------------------------
    // 3) SÜTUNLAR
    // ----------------------------------
    var tabloSutunlari = [
        { header: "Evrak No", name: "evrakNo", width: 100 },
        { header: "Tarih", name: "tarih", width: 120 },
        { header: "Stok Kodu", name: "stokKod", width: 130 },
        { header: "Stok Adı", name: "stokAdi", minWidth: 220 },
        { header: "Planlanan Miktar", name: "planlananMiktar", width: 120 },
        { header: "Birim", name: "birim", width: 70 },
        { header: "Durum Kodu", name: "durum", width: 100 },
        { header: "Durum Açıklaması", name: "durumAciklama", width: 150 },
        { header: "Özellik", name: "stokOzellikler", minWidth: 120 }
    ];

    // ----------------------------------
    // 4) GRID OLUŞTUR
    // ----------------------------------
    window.uretimGrid = liste_gridi_olustur("uretimGrid", tabloVerileri, tabloSutunlari, {
        filtreleme: true,
        siralama: true,
        excel: true,
        temizle: true,
        sutunSecimi: true,
        secim: true,  // üretimde seçim olmalı
        toplam: false,
        sabitKolonSayisi: 0,
        bodyHeight: 'fitToParent'
    });

});
</script>


<script>

// =============================================
// ÜRETİME GÖNDER → seçili satırlar yoksa uyar
// =============================================
function uretime_gonder() {
    const selectedRows = window.uretimGrid.getCheckedRows();

    if (!selectedRows || selectedRows.length === 0) {
        showToast("Lütfen en az bir satır seçin!", "warning");
        return;
    }

    // ❌ Durum=1 olmayan satır seçildiyse engelle
    const hataliSatir = selectedRows.find(r => r.durum !== 1);

    if (hataliSatir) {
        showToast(
            `Evrak No ${hataliSatir.evrakNo} olan satırın durumu '${hataliSatir.durum}'. 
            Sadece DURUM = 1 olan satırlar üretime gönderilebilir!`,
            "error"
        );
        return;
    }

    // ✔ Göndereceğimiz body
    const rows = selectedRows.map(r => ({
        evrakNo: r.evrakNo,
        stokKod: r.stokKod,
        stokAdi: r.stokAdi,
        planlananMiktar: r.planlananMiktar,
        birim: r.birim,
        durum: r.durum
    }));

    // AJAX → Backend
    fetch("/Uretim/UretimeGonder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(rows)
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            showToast(res.message, "success");
        } else {
            showToast(res.message, "error");
        }
    })
    .catch(err => {
        console.error("HATA:", err);
        showToast("Sunucuya bağlanılamadı!", "error");
    });
}




// ÇIKTI (şimdilik boş)
function uretim_pdf() {
    showToast("PDF özelliği daha eklenmedi.", "info");
}

</script>

}
