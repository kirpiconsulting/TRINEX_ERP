using erpv01.Data;
using erpv01.Models.Entities;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Globalization;

namespace erpv01.Controllers
{
    public class UretimController : Controller
    {
        private readonly AppDbContext _db;

        public UretimController(AppDbContext db)
        {
            _db = db;
        }

        // ------------ DTO ----------------
        public class UretimListeDto
        {
            public string EvrakNo { get; set; }
            public DateTime Tarih { get; set; }
            public string StokKod { get; set; }
            public string StokAdi { get; set; }
            public decimal PlanlananMiktar { get; set; }
            public string Birim { get; set; }
            public int? Durum { get; set; }        // ← EKLENDİ
            public string DurumAciklama { get; set; }
            public string AcikKapali { get; set; }
            public string CariEvrakNo { get; set; }
            public string CariKalemKodu { get; set; }
            public string StokOzellikler { get; set; }
        }

        // ------------ LİSTE1 -------------
        public IActionResult Liste1()
        {
            var liste = _db.IsEmirleris
                .Select(i => new UretimListeDto
                {
                    EvrakNo = i.EvrakNo,
                    Tarih = i.Tarih,
                    StokKod = i.StokKod,

                    // stok adı
                    StokAdi = _db.Stoklars
                                .Where(s => s.Kod == i.StokKod)
                                .Select(s => s.Ad)
                                .FirstOrDefault(),

                    // planlanan miktar
                    PlanlananMiktar = i.PlanlananMiktar,
                    Birim = i.StokBirim,
                    Durum = i.Durum,

                    // CASE WHEN karşılığı
                    DurumAciklama =
                        i.Durum == 1 ? "İş emri oluşturuldu" :
                        i.Durum == 2 ? "Üretime gönderildi" :
                        i.Durum == 3 ? "Üretim tamamlandı" :
                        "Bilinmiyor",

                    AcikKapali = i.AcikKapali,
                    CariEvrakNo = i.CariSiparisEvrakno,
                    CariKalemKodu = i.CariSiparisKalemKodu,

                    // stok özellik (ek_alan_3)
                    StokOzellikler = _db.Stoklars
                                        .Where(s => s.Kod == i.StokKod)
                                        .Select(s => s.EkAlan3)
                                        .FirstOrDefault()
                })
                .OrderByDescending(x => x.Tarih)
                .ToList();

            return View(liste);
        }


        public class UretimGonderDto
        {
            public string EvrakNo { get; set; }
            public string StokKod { get; set; }
            public string StokAdi { get; set; }
            public decimal PlanlananMiktar { get; set; }
            public string Birim { get; set; }
            public int Durum { get; set; }
        }


        [HttpPost]
        public IActionResult UretimeGonder([FromBody] List<UretimGonderDto> liste)
        {
            if (liste == null || liste.Count == 0)
            {
                return Json(new { success = false, message = "Gönderilen veri yok!" });
            }

            var Tarih = DateTime.Now;


            var sonNumara1 = _db.SureKayitlaris
                .OrderByDescending(x => x.EvrakNo)
                .Select(x => x.EvrakNo)
                .FirstOrDefault();

            int yeniNumara1 = (int.TryParse(sonNumara1, out int num) ? num : 0) + 1;

            foreach (var item in liste)
            {
                var isEmri = _db.IsEmirleris
                    .FirstOrDefault(x => x.EvrakNo == item.EvrakNo);

                // Eğer DB’de yoksa → atla
                if (isEmri == null)
                {
                    Console.WriteLine($"❌ EvrakNo {item.EvrakNo} için iş emri bulunamadı — atlanıyor.");
                    continue;
                }

                isEmri.Durum = 2;
                isEmri.GuncellemeTarihi = Tarih;
                isEmri.GuncelleyenKullanici = "ENTEGRASYON_01";

                var ilkKalem = _db.IsEmriKalemleris
                    .Where(k => k.EvrakNo == item.EvrakNo && k.KaynakTipi == 0)
                    .OrderBy(k => k.SiraNumarasi)
                    .FirstOrDefault();

                if (ilkKalem == null)
                {
                    Console.WriteLine($"❌ Evrak {item.EvrakNo} için uygun iş emri kalemi yok.");
                    continue;
                }

                ilkKalem.BaslangicTarihi = Tarih;
                ilkKalem.GerceklesenBaslama = Tarih;
                ilkKalem.Durum = 2;
                ilkKalem.GuncellemeTarihi = Tarih;
                ilkKalem.GuncelleyenKullanici = "ENTEGRASYON_01";


                

                var model1 = new SureKayitlari
                {
                    EvrakNo = yeniNumara1.ToString(),
                    Tarih = Tarih,
                    IsEmriNo = ilkKalem.EvrakNo,
                    IsEmriKalemKodu = ilkKalem.KalemKodu,
                    OperasyonKod = ilkKalem.OperasyonKod,
                    KayitTipi = 1,
                    IslemKodu = 1,
                    StokKod = isEmri.StokKod,
                    KayitBaslangic = Tarih,
                    OlusturmaTarihi = Tarih,
                    OlusturanKullanici = "ENTEGRASYON_01"
                };

                

                _db.SureKayitlaris.Add(model1);
                



                yeniNumara1++;

            }

            try
            {
                _db.SaveChanges();

                return Json(new
                {
                    success = true,
                    message = "İş emirleri başarıyla üretime gönderildi."
                });
            }
            catch (Exception ex)
            {
                // HATAYI LOG'A YAZ
                Console.WriteLine("❌ HATA: " + ex.Message);

                return Json(new
                {
                    success = false,
                    message = "Kayıt sırasında hata oluştu: " + ex.Message
                });
            }
        }



        public class OperatorDto
        {
            public string Kod { get; set; }
            public string Ad { get; set; }
            public string CalisabilecegiTezgahlar { get; set; }
        }



        public IActionResult UretimBildirimi1()
        {
            var operatorler = _db.Operatorlers
                .Select(o => new OperatorDto
                {
                    Kod = o.Kod,
                    Ad = o.Ad,
                    CalisabilecegiTezgahlar = o.CalisabilecegiTezgahlar
                })
                .ToList();

            return View(operatorler);
        }


        [HttpPost]
        public IActionResult BekleyenIsEmirleri([FromBody] BekleyenIsEmriRequest dto)
        {
            if (dto == null || string.IsNullOrWhiteSpace(dto.OperatorKod))
            {
                return Json(new { success = false, message = "Operatör bilgisi gelmedi!" });
            }

            if (dto.Tezgahlar == null || dto.Tezgahlar.Count == 0)
            {
                return Json(new { success = false, message = "Operatörün çalışabileceği tezgah bulunamadı!" });
            }

            var tezgahListesi = dto.Tezgahlar
                .Where(t => !string.IsNullOrWhiteSpace(t))
                .ToList();

            if (tezgahListesi.Count == 0)
                return Json(new { success = false, message = "Geçerli tezgah bulunamadı!" });

            // === BEKLEYEN İŞ EMİRLERİ ===
            var liste = (
                from kal in _db.IsEmriKalemleris
                where kal.KaynakTipi == 0
                      && kal.Durum == 2                         // bekleyen
                      && tezgahListesi.Contains(kal.KaynakKod)  // operatörün tezgahları
                orderby kal.EvrakNo, kal.SiraNumarasi
                select new
                {
                    // İş Emri Numarası
                    isEmriNumarasi = kal.EvrakNo,

                    // Kalem Kodu
                    kalemKodu = kal.KalemKodu,

                    tezgahKodu = kal.KaynakKod,

                    // Tezgah Adı
                    tezgahAdi = _db.Tezgahlars
                        .Where(t => t.Kod == kal.KaynakKod)
                        .Select(t => t.Ad)
                        .FirstOrDefault(),

                    // Başlangıç Tarihi
                    baslangicTarihi = kal.GerceklesenBaslama,

                    // Stok Kodu
                    stokKodu = _db.IsEmirleris
                        .Where(i => i.EvrakNo == kal.EvrakNo)
                        .Select(i => i.StokKod)
                        .FirstOrDefault(),

                    // Stok Adı
                    stokAdi = _db.Stoklars
                        .Where(s => s.Kod == (
                            _db.IsEmirleris
                                .Where(i => i.EvrakNo == kal.EvrakNo)
                                .Select(i => i.StokKod)
                                .FirstOrDefault()
                        ))
                        .Select(s => s.Ad)
                        .FirstOrDefault(),

                    // Birim
                    birim = _db.IsEmirleris
                        .Where(i => i.EvrakNo == kal.EvrakNo)
                        .Select(i => i.StokBirim)
                        .FirstOrDefault(),

                    // Stok Özellikler
                    stokOzellikler = _db.Stoklars
                        .Where(s => s.Kod == (
                            _db.IsEmirleris
                                .Where(i => i.EvrakNo == kal.EvrakNo)
                                .Select(i => i.StokKod)
                                .FirstOrDefault()
                        ))
                        .Select(s => s.EkAlan3)
                        .FirstOrDefault()
                }
            ).ToList();

            return Json(new
            {
                success = true,
                data = liste
            });
        }


        public class BekleyenIsEmriRequest
        {
            public string OperatorKod { get; set; }
            public List<string> Tezgahlar { get; set; }
        }




        public class LotCozumDto
        {
            public string StokKodu { get; set; }
            public string StokAdi { get; set; }
            public string StokBirim { get; set; }
            public string DepoKodu { get; set; }
            public string DepoAdi { get; set; }

            public string LotKodu { get; set; } // Lot yoksa null/boş
            public decimal Miktar { get; set; } // Kullanılan veya eksik miktar
        }

        public class StokGetirRequest
        {
            public string EvrakNo { get; set; }
            public string TezgahKodu { get; set; }
        }

        [HttpPost]
        [HttpPost]
        public IActionResult StoklariGetir([FromBody] StokGetirRequest dto)
        {
            var evrakNo = dto.EvrakNo;
            var tezgahKod = dto.TezgahKodu;

            // 1) İş emri kalemlerini (senin SQL'deki sırayla) çekiyoruz
            var kalemler = (
                from k in _db.IsEmriKalemleris
                where k.KaynakTipi == 2
                      && k.EvrakNo == evrakNo
                      && k.EkAlan2 == tezgahKod
                // Sıralama önemliyse buraya OrderBy ekleyebilirsin, örneğin satır no'ya göre
                select new
                {
                    StokKodu = k.KaynakKod,
                    Miktar = k.PlanlananMiktar,
                    DepoKodu = k.EkAlan3,
                    StokAdi = _db.Stoklars.Where(s => s.Kod == k.KaynakKod).Select(s => s.Ad).FirstOrDefault(),
                    StokBirim = _db.Stoklars.Where(s => s.Kod == k.KaynakKod).Select(s => s.AnaBirim).FirstOrDefault(),
                    DepoAdi = _db.Depolars.Where(d => d.Kod == k.EkAlan3).Select(d => d.Ad).FirstOrDefault()
                }
            ).ToList();

            // 2) Bu kalemlerde geçen tüm Stok+Depo ikilileri için Lotları çekip hafızaya alalım.
            //    Her stok-depo ikilisi için bir Kuyruk (Queue) oluşturacağız.
            var stokDepoGruplari = kalemler
                .Select(x => new { x.StokKodu, x.DepoKodu })
                .Distinct()
                .ToList();

            // Hafızadaki Lot Havuzu: Key = "StokKodu|DepoKodu", Value = List<LotObjesi>
            var lotHavuzu = new Dictionary<string, List<LotModel>>();

            foreach (var grp in stokDepoGruplari)
            {
                var lotlar = _db.LotSeriTanimlaris
                    .Where(l => l.StokKod == grp.StokKodu
                                && l.DepoKod == grp.DepoKodu
                                && l.StokMiktar > 0)
                    .OrderBy(l => l.Tarih1) // FIFO
                    .ThenBy(l => l.Kod)
                    .Select(l => new LotModel
                    {
                        Kod = l.Kod,
                        Miktar = l.StokMiktar
                    })
                    .ToList();

                string key = $"{grp.StokKodu}|{grp.DepoKodu}";
                lotHavuzu.Add(key, lotlar);
            }

            var sonucList = new List<LotCozumDto>();

            // 3) ŞİMDİ KALEM KALEM DÖNÜYORUZ (Senin istediğin döngü burası)
            foreach (var kal in kalemler)
            {
                decimal buSatirIcinLazim = kal.Miktar;
                string key = $"{kal.StokKodu}|{kal.DepoKodu}";

                // Bu stoğun lot listesini havuzdan bul
                if (!lotHavuzu.ContainsKey(key))
                {
                    // Hiç lot tanımı yoksa direkt boş satır bas
                    sonucList.Add(new LotCozumDto
                    {
                        StokKodu = kal.StokKodu,
                        StokAdi = kal.StokAdi,
                        DepoKodu = kal.DepoKodu,
                        DepoAdi = kal.DepoAdi,
                        LotKodu = "",
                        Miktar = buSatirIcinLazim
                    });
                    continue;
                }

                var uygunLotlar = lotHavuzu[key]; // Bu referans tipli, yani buradan düşersek havuzdan da düşer.

                // Bu satırın ihtiyacını karşılayana kadar lotlardan ye
                while (buSatirIcinLazim > 0)
                {
                    // Kullanılabilir (miktarı 0'dan büyük) ilk lotu bul
                    var aktifLot = uygunLotlar.FirstOrDefault(x => x.Miktar > 0);

                    if (aktifLot == null)
                    {
                        // Stokta lot kalmadı ama ihtiyaç var -> Boş satır ekle
                        sonucList.Add(new LotCozumDto
                        {
                            StokKodu = kal.StokKodu,
                            StokAdi = kal.StokAdi,
                            DepoKodu = kal.DepoKodu,
                            DepoAdi = kal.DepoAdi,
                            LotKodu = "", // Lot yok
                            Miktar = buSatirIcinLazim
                        });
                        buSatirIcinLazim = 0; // Döngüyü kır
                    }
                    else
                    {
                        // Lot var, ne kadar kullanabiliriz?
                        decimal kullanim = Math.Min(buSatirIcinLazim, aktifLot.Miktar);

                        sonucList.Add(new LotCozumDto
                        {
                            StokKodu = kal.StokKodu,
                            StokAdi = kal.StokAdi,
                            DepoKodu = kal.DepoKodu,
                            DepoAdi = kal.DepoAdi,
                            LotKodu = aktifLot.Kod,
                            Miktar = kullanim
                        });

                        // Havuzdan ve ihtiyactan düş
                        aktifLot.Miktar -= kullanim;
                        buSatirIcinLazim -= kullanim;
                    }
                }
            }

            return Json(new { success = true, data = sonucList });
        }

        // Helper class for memory state
        public class LotModel
        {
            public string Kod { get; set; }
            public decimal Miktar { get; set; }
        }




        public class UretimBildirimSatirDto
        {
            public string StokKodu { get; set; }
            public string StokAdi { get; set; }
            public string StokBirim { get; set; }
            public string DepoKodu { get; set; }
            public string DepoAdi { get; set; }
            public string LotKodu { get; set; }
            public decimal Miktar { get; set; }
        }

        // 2) [YENİ] Sayfadan gelecek TÜM veriyi kapsayan Ana Model
        public class UretimBildirimKayitRequest
        {
            // Üst Bilgiler (Header)
            public string IsEmriNo { get; set; }
            public string KalemKodu { get; set; }
            public string TezgahAdi { get; set; }
            public string BaslangicTarihi { get; set; }

            public string UrunStokKodu { get; set; }     // Üretilen ürünün kodu
            public string UrunStokAdi { get; set; }
            public string UrunBirim { get; set; }
            public string UrunOzellikler { get; set; }

            public string OperatorKod { get; set; }

            // Alt Liste (Grid Verileri)
            public List<UretimBildirimSatirDto> Satirlar { get; set; }
        }

        [HttpPost]
        public IActionResult UretimBildirimiKaydet([FromBody] UretimBildirimKayitRequest veri)
        {
            var Tarih = DateTime.Now;

            try
            {
                // 1) Lot Kontrolü
                if (veri.Satirlar != null && veri.Satirlar.Count > 0)
                {
                    var kontrolSonucu = LotStokKontrolu(veri.Satirlar);
                    if (!kontrolSonucu.basarili)
                        return Json(new { success = false, message = kontrolSonucu.mesaj });
                }

                var isemri = _db.IsEmirleris
                    .FirstOrDefault(x => x.EvrakNo == veri.IsEmriNo);


                var sureKaydi = _db.SureKayitlaris
                    .FirstOrDefault(x =>
                        x.IsEmriNo == veri.IsEmriNo &&
                        Convert.ToInt32(x.IsEmriKalemKodu) == Convert.ToInt32(veri.KalemKodu) &&
                        x.KayitBaslangic != null &&
                        x.KayitBitis == null
                    );


                sureKaydi.KayitBitis = Tarih;
                sureKaydi.GuncelleyenKullanici = "ENTEGRASYON-01";
                sureKaydi.GuncellemeTarihi = Tarih;



       


                var sonNumara1 = _db.SureKayitlaris
                .OrderByDescending(x => x.EvrakNo)
                .Select(x => x.EvrakNo)
                .FirstOrDefault();

                int yeniNumara1 = (int.TryParse(sonNumara1, out int num) ? num : 0) + 1;



                int sayac1 = 1;
                foreach (var satir in veri.Satirlar)
                {
                    var model1 = new SureKayitlariKalemleri
                    {
                        EvrakNo = yeniNumara1.ToString(),
                        KalemKodu = sayac1,
                        SiraNumarasi = sayac1,
                        StokKod = satir.StokKodu,
                        StokMiktar = satir.Miktar,
                        StokBirim = satir.StokBirim,
                        LotNo = satir.LotKodu,
                        Tarih = Tarih,
                        OlusturmaTarihi = Tarih,
                        OlusturanKullanici = "ENTEGRASYON-01"
                    };

                    sayac1++;
                }


                var model2 = new SureKayitlariOperatorler
                {
                    EvrakNo = yeniNumara1.ToString(),
                    SiraNumarasi = 1,
                    OperatorKod = veri.OperatorKod,
                    KalemKodu = 1,
                    Tarih = Tarih,
                    OlusturanKullanici = "ENTEGRASYON-01",
                    OlusturmaTarihi = Tarih
                };



                    // 2) Sıra Kontrolü (İlk - Ara - Son)
                    var kalemler = _db.IsEmriKalemleris
                    .Where(x => x.EvrakNo == veri.IsEmriNo && x.KaynakTipi == 0)
                    .OrderBy(x => x.SiraNumarasi)
                    .ToList();





                if (kalemler.Any())
                {

  

                    var ilkSira = kalemler.First().SiraNumarasi;
                    var sonSira = kalemler.Last().SiraNumarasi;


           

                    var aktifSatir = kalemler.FirstOrDefault(x => x.KalemKodu.ToString() == veri.KalemKodu.ToString());

   

                    if (aktifSatir != null)
                    {

                        aktifSatir.Durum = 3;
                        aktifSatir.BitisTarihi = Tarih;
                        aktifSatir.GerceklesenBitis = Tarih;
                        aktifSatir.GuncellemeTarihi = Tarih;
                        aktifSatir.GuncelleyenKullanici = "ENTEGRASYON-01";

                        if (aktifSatir.SiraNumarasi == ilkSira)
                        {
                            yeniNumara1++;


                            var sonrakiKalem = kalemler
                                .Where(x => x.SiraNumarasi > aktifSatir.SiraNumarasi)
                                .OrderBy(x => x.SiraNumarasi)
                                .FirstOrDefault();

                            var model3 = new SureKayitlari
                            {
                                EvrakNo = yeniNumara1.ToString(),
                                Tarih = Tarih,
                                IsEmriNo = sonrakiKalem.EvrakNo,
                                OperasyonKod = sonrakiKalem.OperasyonKod,
                                KayitTipi = 1,
                                IslemKodu = 1,
                                StokKod = isemri.StokKod,
                                IsEmriKalemKodu = sonrakiKalem.KalemKodu,
                                KayitBaslangic = Tarih,
                                OlusturanKullanici = "ENTEGRASYON-01",
                                OlusturmaTarihi = Tarih
                            };

                        }
                        else if (aktifSatir.SiraNumarasi == sonSira)
                        {
                            isemri.UretilenMiktar = 1;
                            isemri.BakiyeMiktar = 0;
                            isemri.KapanisTarihi = Tarih;
                            isemri.Durum = 3;
                            isemri.AcikKapali = "K";
                            isemri.GuncellemeTarihi = Tarih;
                            isemri.GuncelleyenKullanici = "ENTEGRASYON-01";

                            var sonNumara10 = _db.UretimFisleris
                                .OrderByDescending(x => x.EvrakNo)
                                .Select(x => x.EvrakNo)
                                .FirstOrDefault();

                            int yeniNumara10 = (int.TryParse(sonNumara10, out int num10) ? num10 : 0) + 1;

                            var m1 = new UretimFisleri
                            {
                                EvrakNo = yeniNumara10.ToString(),
                                Tarih = Tarih,
                                UretimDeposuKodu = isemri.EkAlan2,
                                TuketimDeposuKodu = aktifSatir.EkAlan3,
                                OlusturmaTarihi = Tarih,
                                OlusturanKullanici = "ENTEGRASYON-01"
                            };

                            var m2 = new UretimFisiKalemleri
                            {
                                EvrakNo = yeniNumara10.ToString(),
                                KalemKodu = "1",
                                SiraNumarasi = 1,
                                StokKod = isemri.StokKod,
                                Miktar = 1,
                                Birim = isemri.StokBirim,
                                OlusturmaTarihi = Tarih,
                                OlusturanKullanici = "ENTEGRASYON-01"

                            };


                            var kayit = _db.SureKayitlaris
                                    .FirstOrDefault(x => x.IsEmriNo == isemri.EvrakNo);

                            string sureEvrakNo = kayit.EvrakNo;

                            var surekalemleri = _db.SureKayitlariKalemleris
                                    .Where(x => x.EvrakNo == sureEvrakNo)
                                    .ToList();



                            var sayac = 1;
                            foreach(var surek in surekalemleri)
                            {
                                var m3 = new UretimFisiTuketimler
                                {
                                    EvrakNo = yeniNumara10.ToString(),
                                    KalemKodu = sayac.ToString(),
                                    SiraNumarasi = sayac,
                                    StokKod = surek.StokKod,
                                    LotNo = surek.LotNo,
                                    Miktar = surek.StokMiktar,
                                    Birim = surek.StokBirim,
                                    Tarih = Tarih,
                                    KarsiStokKod = isemri.StokKod,
                                    KarsiMiktar = 1,
                                    OlusturmaTarihi = Tarih,
                                    OlusturanKullanici = "ENTEGRASYON-01"

                                };

                                sayac++;
                            }


                        }
                        else
                        {
                            yeniNumara1++;

                            var sonrakiKalem = kalemler
                                .Where(x => x.SiraNumarasi > aktifSatir.SiraNumarasi)
                                .OrderBy(x => x.SiraNumarasi)
                                .FirstOrDefault();


                            var model3 = new SureKayitlari
                            {
                                EvrakNo = yeniNumara1.ToString(),
                                Tarih = Tarih,
                                IsEmriNo = sonrakiKalem.EvrakNo,
                                OperasyonKod = sonrakiKalem.OperasyonKod,
                                KayitTipi = 1,
                                IslemKodu = 1,
                                StokKod = isemri.StokKod,
                                IsEmriKalemKodu = sonrakiKalem.KalemKodu,
                                KayitBaslangic = Tarih,
                                OlusturanKullanici = "ENTEGRASYON-01",
                                OlusturmaTarihi = Tarih
                            };
                        }
                    }
                }

                return Json(new { success = true, message = "Kontroller başarılı, kayıt işlemi tamam dedem!" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Sunucu Hatası: " + ex.Message });
            }
        }


        private (bool basarili, string mesaj) LotStokKontrolu(List<UretimBildirimSatirDto> gelenSatirlar)
        {
            // 1) İstenenleri Grupla
            var grupluListe = gelenSatirlar
                .Where(x => !string.IsNullOrEmpty(x.LotKodu))
                .GroupBy(x => new { x.StokKodu, x.DepoKodu, x.LotKodu })
                .Select(g => new
                {
                    g.Key.StokKodu,
                    g.Key.DepoKodu,
                    g.Key.LotKodu,
                    ToplamIstenen = g.Sum(x => x.Miktar)
                })
                .ToList();

            foreach (var kalem in grupluListe)
            {
                // 2) DB'den veriyi çek
                var dbLotListesi = _db.LotSeriTanimlaris
                    .Where(l => l.StokKod == kalem.StokKodu
                                && l.DepoKod == kalem.DepoKodu
                                && l.Kod == kalem.LotKodu)
                    .ToList();


                foreach (var l in dbLotListesi)
                {
                    Console.WriteLine($"Type: {l.StokMiktar.GetType()} | Value: {l.StokMiktar}");
                }


                decimal dbMevcutStok = 0;

                foreach (var l in dbLotListesi)
                {
                    // HATA DÜZELTİLDİ: 
                    // Senin modelinde StokMiktar zaten 'decimal' olduğu için 
                    // .Value veya .HasValue kullanmıyoruz. Direkt kendisini topluyoruz.
                    dbMevcutStok += l.StokMiktar;
                }

                // --- DEBUG LOGU ---
                // Sayıyı 'Nokta' ile formatlayıp basıyoruz ki gerçek değerini görelim.
                string dbStokStr = dbMevcutStok.ToString(CultureInfo.InvariantCulture);
                string istenenStr = kalem.ToplamIstenen.ToString(CultureInfo.InvariantCulture);

                Console.WriteLine($"--------------------------------------------------");
                Console.WriteLine($"[KONTROL] Lot: {kalem.LotKodu}");
                Console.WriteLine($"   -> DB Stok (Ham): {dbMevcutStok}");
                Console.WriteLine($"   -> DB Stok (Net): {dbStokStr}"); // Burada nokta/virgül karmaşası olmaz
                Console.WriteLine($"   -> İstenen:       {istenenStr}");
                Console.WriteLine($"--------------------------------------------------");

                // 3) Karşılaştırma
                if (dbMevcutStok < kalem.ToplamIstenen)
                {
                    return (false, $"Yetersiz Bakiye! \nLot: {kalem.LotKodu} \nMevcut: {dbMevcutStok:N2} \nİstenen: {kalem.ToplamIstenen:N2}");
                }
            }

            return (true, "Kontrol başarılı");
        }



    }
}








@model List<erpv01.Controllers.UretimController.OperatorDto>

@{
    ViewData["Title"] = "Üretim Bildirme - 1";
    Layout = "_Layout";
}

<div class="container-fluid mt-3">

    <div class="row mb-3">
        <div class="col-12 col-md-4">
            <label class="fw-semibold mb-1">Operatör Seçimi</label>
            <select id="operatorSelect" class="form-select">
                <option value="">-- Operatör Seçin --</option>

                @foreach (var op in Model)
                {
                    <option value="@op.Kod"
                            data-tezgah="@op.CalisabilecegiTezgahlar">
                        @op.Ad
                    </option>
                }
            </select>
        </div>
    </div>

    <div class="row">

        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header py-2">
                    <span class="fw-semibold">
                        <i class="fa-solid fa-list-check me-2"></i> Bekleyen İş Emirleri
                    </span>
                </div>
                <div class="card-body p-0">
                    <div id="bekleyenGrid" style="height: calc(100vh - 260px); width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header py-2">
                    <span class="fw-semibold">
                        <i class="fa-solid fa-industry me-2"></i> Üretim Bildirimi
                    </span>
                </div>

                <div class="card-body small" id="uretimBildirimiContainer" style="display:flex; flex-direction:column; height:100%;">

                    <div id="seciliDetayBolumu">
                        <div id="seciliDetayBos" class="text-muted text-center mb-2">
                            Bekleyen iş emirlerinden bir satıra <b>çift tıklayın</b> dedem.
                        </div>

                        <div id="seciliDetayIcerik" style="display:none;">
                            <div class="mb-1">
                                <span class="fw-semibold">İş Emri No:</span>
                                <span id="d_isEmriNumarasi" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Kalem Kodu:</span>
                                <span id="d_kalemKodu" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Tezgah:</span>
                                <span id="d_tezgahAdi" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Başlangıç Tarihi:</span>
                                <span id="d_baslangicTarihi" class="ms-1"></span>
                            </div>
                            <hr class="my-2" />
                            <div class="mb-1">
                                <span class="fw-semibold">Stok Kodu:</span>
                                <span id="d_stokKodu" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Stok Adı:</span>
                                <span id="d_stokAdi" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Birim:</span>
                                <span id="d_birim" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Stok Özellikler:</span>
                                <span id="d_stokOzellikler" class="ms-1"></span>
                            </div>
                        </div>
                    </div>

                    <div id="uretBilToolbar"
                         class="mt-2 d-flex justify-content-end gap-2"
                         style="display:none;">
                        <button type="button"
                                class="btn-erp-base"
                                onclick="btnStoklariGetirClick()">
                            <i class="fa-solid fa-box-open me-1"></i> Stokları Getir
                        </button>


                    </div>

                    <div id="lotGridContainer" class="mt-2"
                         style="flex:1; min-height:200px; height:100%;">
                    </div>

                    <div id="kaydet"
                         class="mt-2 d-flex justify-content-end gap-2"
                         style="display:none !important;">
                        <button type="button"
                                class="btn-erp-base"
                                onclick="btnKaydet()">
                            <i class="fa-solid fa-save me-1"></i> Kaydet
                        </button>


                    </div>

                </div>
            </div>
        </div>

        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header py-2">
                    <span class="fw-semibold">
                        <i class="fa-solid fa-check-double me-2"></i> Tamamlanan İş Emirleri
                    </span>
                </div>
                <div class="card-body small text-muted d-flex align-items-center justify-content-center text-center">
                    Buraya sonra tamamlanan iş emirleri listesini koyarız dedem.
                </div>
            </div>
        </div>

    </div>

</div>

@section Scripts {
    <script>
        // Global Değişkenler
        let seciliIsEmriRow = null;
        let lotGrid = null;
        let bekleyenGrid = null;

        // =========================================================
        // 1. STOKLARI GETİR
        // =========================================================
        function btnStoklariGetirClick() {
            if (!seciliIsEmriRow) {
                showToast("Lütfen önce bekleyen iş emirlerinden bir satıra çift tıklayın.", "warning");
                return;
            }

            const evrakNo   = seciliIsEmriRow.isEmriNumarasi;
            const tezgahKod = seciliIsEmriRow.tezgahKodu;

            if (!evrakNo || !tezgahKod) {
                console.log("Eksik bilgi:", { evrakNo, tezgahKod });
                showToast("Evrak no veya tezgah kodu bulunamadı.", "error");
                return;
            }

            fetch("/Uretim/StoklariGetir", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ evrakNo: evrakNo, tezgahKodu: tezgahKod })
            })
            .then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
            .then(res => {
                if (res.success !== true) {
                    showToast(res.message || "Stoklar getirilemedi!", "error");
                    if (lotGrid) lotGrid.resetData([]);
                    return;
                }

                const data = Array.isArray(res.data) ? res.data : [];

                if (!lotGrid) {
                    initLotGrid(data);
                } else {
                    lotGrid.resetData(data);
                }

                if(data.length > 0) {
                    showToast("Stoklar ve lotlar hesaplandı.", "success");

                    // --- BURAYI EKLE DEDEM ---
                    document.getElementById("kaydet").style.display = "flex";
                    // -------------------------
                }
                else {
                    showToast("Kayıt bulunamadı.", "info");
                    // Veri yoksa buton açılmasın
                    document.getElementById("kaydet").style.setProperty("display", "none", "important");
                }
            })
            .catch(err => {
                console.error("Hata:", err);
                showToast("Sunucu hatası!", "error");
            });
        }

        // =========================================================
        // 2. SATIR EKLE (MANUEL)
        // =========================================================
        function lotSatirEkle() {
            if (!lotGrid) {
                showToast("Önce bir iş emri seçip stokları getir.", "warning");
                return;
            }
            // İlk satırdan bilgileri kopyala
            const base = lotGrid.getRow(0) || {};
            lotGrid.appendRow({
                stokKodu: base.stokKodu || "",
                stokAdi: base.stokAdi || "",
                depoKodu: base.depoKodu || "",
                depoAdi: base.depoAdi || "",
                lotKodu: "",
                miktar: 0
            }, { at: lotGrid.getRowCount() });
        }

        // =========================================================
        // 3. LOT GRID YAPISI
        // =========================================================
        function initLotGrid(initialData) {

            // Silme Butonu
            class SilButtonRenderer {
                constructor(props) {
                    const el = document.createElement("button");
                    el.type = "button";
                    el.className = "btn btn-sm btn-outline-danger border-0";
                    el.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    el.onclick = (e) => { e.stopPropagation(); props.grid.removeRow(props.rowKey); };
                    this.el = el;
                }
                getElement() { return this.el; }
            }

            // Kopyala Butonu
            class KopyalaButtonRenderer {
                 constructor(props) {
                    const el = document.createElement("button");
                    el.type = "button";
                    el.className = "btn btn-sm btn-outline-primary border-0 me-1";
                    el.innerHTML = '<i class="fa-solid fa-copy"></i>';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        const row = props.grid.getRow(props.rowKey);
                        props.grid.appendRow({
                            stokKodu: row.stokKodu,
                            stokAdi: row.stokAdi,
                            depoKodu: row.depoKodu,
                            depoAdi: row.depoAdi,
                            lotKodu: "",
                            miktar: 0
                        }, { at: props.rowKey + 1 });
                    };
                    this.el = el;
                }
                getElement() { return this.el; }
            }

            // İşlemler Kolonu
            class IslemlerRenderer {
                constructor(props) {
                    const div = document.createElement("div");
                    div.className = "text-center";

                    const btnKopyala = new KopyalaButtonRenderer(props).getElement();
                    const btnSil = new SilButtonRenderer(props).getElement();

                    div.appendChild(btnKopyala);
                    div.appendChild(btnSil);
                    this.el = div;
                }
                getElement() { return this.el; }
            }

            // --- KOLONLAR BURADA DÜZENLENDİ ---
            const lotKolonlar = [
                { header: "Stok Kodu",  name: "stokKodu", width: 100 },
                { header: "Stok Adı",   name: "stokAdi",  minWidth: 150 },
                { header: "Stok Birim",   name: "stokBirim",  minWidth: 150 },
                { header: "Depo Kodu",  name: "depoKodu", width: 80 },
                { header: "Depo Adı",   name: "depoAdi",  minWidth: 100 },
                {
                    header: "Lot No",
                    name: "lotKodu",
                    width: 120,
                    editor: { type: "text" }
                },
                {
                    header: "Miktar",
                    name: "miktar",
                    width: 90,
                    align: "right",
                    editor: { type: "text" }
                },
                {
                    header: "İşlemler",
                    name: "_islemler",
                    width: 90,
                    align: "center",
                    renderer: { type: IslemlerRenderer }
                }
            ];

            lotGrid = liste_gridi_olustur("lotGridContainer", initialData, lotKolonlar, {
                filtreleme: false,
                siralama: false,
                temizle: false,
                bodyHeight: 100,
                secim: false,
                excel: false,
                sutunSecimi: false,
            });
        }

        // =========================================================
        // 4. SAYFA YÜKLENİNCE
        // =========================================================
        document.addEventListener("DOMContentLoaded", function () {

            const operatorSelect = document.getElementById("operatorSelect");

            // Bekleyen İş Emirleri Grid
            const bekleyenKolonlar = [
                { header: "İş Emri No",  name: "isEmriNumarasi",  width: 120 },
                { header: "Kalem",       name: "kalemKodu",       width: 90 },
                { header: "Tezgah Kod",  name: "tezgahKodu",      hidden: true },
                { header: "Tezgah",      name: "tezgahAdi",       minWidth: 120 },
                { header: "Başlangıç",   name: "baslangicTarihi", width: 130 },
                { header: "Stok Kodu",   name: "stokKodu",        width: 110 },
                { header: "Stok Adı",    name: "stokAdi",         minWidth: 180 },
                { header: "Birim",       name: "birim",           width: 70 },
                { header: "Özellik",     name: "stokOzellikler",  minWidth: 100 }
            ];

            window.bekleyenGrid = liste_gridi_olustur("bekleyenGrid", [], bekleyenKolonlar, {
                filtreleme: true,
                siralama: true,
                temizle: true,
                sutunSecimi: true,
                bodyHeight: 'fitToParent',
                secim: false,
                excel: false,
               
            });

            // Bekleyen Grid Çift Tıklama
            window.bekleyenGrid.on('dblclick', function (ev) {
                if (ev.rowKey === undefined || ev.rowKey === null) return;
                const row = window.bekleyenGrid.getRow(ev.rowKey);
                if (!row) return;

                seciliIsEmriRow = row;

                const bos      = document.getElementById("seciliDetayBos");
                const icerik   = document.getElementById("seciliDetayIcerik");
                const toolbar  = document.getElementById("uretBilToolbar");

                const kaydetBtn = document.getElementById("kaydet");

                if (bos)     bos.style.display    = "none";
                if (icerik)  icerik.style.display = "block";
                if (toolbar) toolbar.style.display = "flex";

                if (kaydetBtn) document.getElementById("kaydet").style.setProperty("display", "none", "important");

                document.getElementById("d_isEmriNumarasi").innerText  = row.isEmriNumarasi  || "";
                document.getElementById("d_kalemKodu").innerText       = row.kalemKodu       || "";
                document.getElementById("d_tezgahAdi").innerText       = row.tezgahAdi       || "";
                document.getElementById("d_baslangicTarihi").innerText = row.baslangicTarihi || "";
                document.getElementById("d_stokKodu").innerText        = row.stokKodu        || "";
                document.getElementById("d_stokAdi").innerText         = row.stokAdi         || "";
                document.getElementById("d_birim").innerText           = row.birim           || "";
                document.getElementById("d_stokOzellikler").innerText  = row.stokOzellikler  || "";

                // Yeni seçimde lot gridini temizle
                if (lotGrid) lotGrid.resetData([]);
            });

            if (!operatorSelect) return;

            // Operatör Değişimi
            operatorSelect.addEventListener("change", function () {
                const kod = this.value;

                function ekranSifirla() {
                    seciliIsEmriRow = null;
                    if (document.getElementById("seciliDetayBos"))
                        document.getElementById("seciliDetayBos").style.display = "block";
                    if (document.getElementById("seciliDetayIcerik"))
                        document.getElementById("seciliDetayIcerik").style.display = "none";
                    if (document.getElementById("uretBilToolbar"))
                        document.getElementById("uretBilToolbar").style.display = "none";
                    if (document.getElementById("kaydet"))
                                // Yanlış (Çalışmaz):
                        document.getElementById("kaydet").style.setProperty("display", "none", "important");
                    if (lotGrid) lotGrid.resetData([]);
                }

                if (!kod) {
                    window.bekleyenGrid.resetData([]);
                    ekranSifirla();
                    return;
                }

                const selectedOpt = this.selectedOptions[0];
                const tezgahStr = (selectedOpt && selectedOpt.getAttribute("data-tezgah")) || "";
                const tezgahlar = tezgahStr.split("|").map(x => x.trim()).filter(x => x.length > 0);

                if (tezgahlar.length === 0) {
                    window.bekleyenGrid.resetData([]);
                    ekranSifirla();
                    showToast("Bu operatör için tanımlı tezgah bulunamadı.", "warning");
                    return;
                }

                fetch("/Uretim/BekleyenIsEmirleri", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ operatorKod: kod, tezgahlar: tezgahlar })
                })
                .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
                .then(res => {
                    if (res.success !== true) {
                        showToast(res.message, "error");
                        window.bekleyenGrid.resetData([]);
                        ekranSifirla();
                        return;
                    }
                    window.bekleyenGrid.resetData(res.data || []);
                    ekranSifirla();
                    if ((res.data || []).length === 0) showToast("Bekleyen iş emri yok.", "info");
                })
                .catch(err => {
                    console.error(err);
                    showToast("Sunucu hatası!", "error");
                });
            });
        });


                function btnKaydet() {
            // 1) Grid kontrolü
            if (!lotGrid) {
                showToast("Lütfen önce işlem yapın.", "warning");
                return;
            }

            // 2) Edit modunu bitir (Hücrede yazılan son veriyi hafızaya al)
            lotGrid.blur();

            // 3) Ham Grid verilerini al
            const rawData = lotGrid.getData();
            if (!rawData || rawData.length === 0) {
                showToast("Kaydedilecek satır yok.", "warning");
                return;
            }

            // --- KRİTİK DÜZELTME: Virgülü Noktaya Çevir ---
            // Kullanıcı "0,17" yazdıysa bunu "0.17" (decimal) formatına çeviriyoruz ki
            // sunucuya sayı olarak doğru gitsin.
            const cleanData = rawData.map(satir => {
                // Miktarı string'e çevir (null veya undefined gelirse güvene al)
                let miktarStr = String(satir.miktar !== null && satir.miktar !== undefined ? satir.miktar : 0);

                // Virgülü nokta ile değiştir
                miktarStr = miktarStr.replace(',', '.');

                // Sayıya (float) çevir, eğer sayı değilse 0 yap
                let miktarSayi = parseFloat(miktarStr) || 0;

                return {
                    ...satir,          // Satırdaki diğer verileri (LotKodu, StokKodu vb.) koru
                    miktar: miktarSayi // Miktarı düzeltilmiş sayı haliyle güncelle
                };
            });
            // ------------------------------------------------

            // 4) Üst Bilgileri HTML'den Oku
            const baslikBilgisi = {
                IsEmriNo:        document.getElementById("d_isEmriNumarasi").innerText,
                KalemKodu:       document.getElementById("d_kalemKodu").innerText,
                TezgahAdi:       document.getElementById("d_tezgahAdi").innerText,
                BaslangicTarihi: document.getElementById("d_baslangicTarihi").innerText,
                UrunStokKodu:    document.getElementById("d_stokKodu").innerText,
                UrunStokAdi:     document.getElementById("d_stokAdi").innerText,
                UrunBirim:       document.getElementById("d_birim").innerText,
                UrunOzellikler:  document.getElementById("d_stokOzellikler").innerText,
                operatorKod: document.getElementById("operatorSelect")

            };

            // 5) Hepsini tek bir pakette birleştir
            const gonderilecekPaket = {
                ...baslikBilgisi,   // Başlık bilgilerini pakete ekle
                Satirlar: cleanData // Düzeltilmiş satır verilerini ekle
            };

            // Konsola basıp kontrol edelim (F12'de görebilirsin)
            console.log("Sunucuya Giden Paket:", gonderilecekPaket);

            // 6) Sunucuya Gönder (Butonu pasife alarak)
            const btn = document.querySelector("#kaydet button");
            if(btn) btn.disabled = true;

            fetch('/Uretim/UretimBildirimiKaydet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gonderilecekPaket)
            })
            .then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
            .then(res => {
                if (res.success) {
                    showToast(res.message, "success");

                    // İstersen başarılı işlemden sonra temizlik yapabilirsin:
                    // lotGrid.resetData([]);
                    // document.getElementById("kaydet").style.setProperty("display", "none", "important");

                } else {
                    showToast(res.message, "error");
                }
            })
            .catch(err => {
                console.error("Kaydet Hatası:", err);
                showToast("Sunucuyla iletişim hatası!", "error");
            })
            .finally(() => {
                // İşlem bitince butonu tekrar aktif et
                if(btn) btn.disabled = false;
            });
        }
                    
                    
                
                
                    
                    
                
    </script>
}