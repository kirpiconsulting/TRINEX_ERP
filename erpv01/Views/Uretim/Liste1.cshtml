@model List<erpv01.Controllers.UretimController.UretimListeDto>

@{
    ViewData["Title"] = "Üretim İş Emirleri";
    Layout = "_Layout";
}


<style>
    /* Durum 1: İş Emri Oluşturuldu (Mavi tonu - Başlangıç) */
    .durum-1-satir {
        background-color: #e3f2fd !important; /* Açık Mavi */
        color: #0d47a1 !important;
    }

    /* Durum 2: Üretime Gönderildi (Sarı/Turuncu tonu - İşlemde) */
    .durum-2-satir {
        background-color: #fff3cd !important; /* Açık Sarı */
        color: #856404 !important;
    }

    /* Durum 3: Üretim Tamamlandı (Yeşil tonu - Bitti) */
    .durum-3-satir {
        background-color: #d4edda !important; /* Açık Yeşil */
        color: #155724 !important;
    }

    /* Hover efektleri (Üzerine gelince renk bozulmasın) */
    .durum-1-satir:hover { background-color: #bbdefb !important; }
    .durum-2-satir:hover { background-color: #ffeeba !important; }
    .durum-3-satir:hover { background-color: #c3e6cb !important; }
</style>                             


<div class="container-fluid mt-3 mb-3">

    <!-- TOOLBAR -->
    <div class="row mb-2">
        <div class="col-12">
            <div id="listeToolbar"></div>
        </div>
    </div>

    <!-- GRID -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div id="uretimGrid" style="height: calc(100vh - 180px); width: 100%;"></div>
        </div>
    </div>
</div>


@section Scripts {

<script>
    document.addEventListener("DOMContentLoaded", function () {

    // ----------------------------------
    // 1) TOOLBAR (Satıştaki AYNI sistem)
    // ----------------------------------

    liste_ekrani_butonlari_olustur("listeToolbar", {
        fonksiyonlar: [
            { ad: "Üretime Gönder", action: "uretime_gonder" }
        ],
        ciktilar: [
            { ad: "İş Emri Çıktısı Oluştur", action: "is_emri_ciktisi_olustur" }
        ]
    });

    // ----------------------------------
    // 2) MODELDEN GERÇEK DATA (camelCase)
    // ----------------------------------
    var tabloVerileri = @Html.Raw(
        System.Text.Json.JsonSerializer.Serialize(
            Model,
            new System.Text.Json.JsonSerializerOptions {
                PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
            }
        )
    );

    tabloVerileri.forEach(function(satir) {
    let cssClass = "";

    if (satir.durum === 1) {
        cssClass = "durum-1-satir";
    } else if (satir.durum === 2) {
        cssClass = "durum-2-satir";
    } else if (satir.durum === 3) {
        cssClass = "durum-3-satir";
    }

    if (cssClass !== "") {
        satir._attributes = {
            className: {
                row: [cssClass]
            }
        };
    }
});


    // ----------------------------------
    // 3) SÜTUNLAR
    // ----------------------------------
    var tabloSutunlari = [
        { header: "Evrak No", name: "evrakNo", width: 100 },
        { header: "Tarih", name: "tarih", width: 120 },
        { header: "Stok Kodu", name: "stokKod", width: 130 },
        { header: "Stok Adı", name: "stokAdi", minWidth: 220 },
        { header: "Planlanan Miktar", name: "planlananMiktar", width: 120 },
        { header: "Birim", name: "birim", width: 70 },
        { header: "Durum Kodu", name: "durum", width: 100 },
        { header: "Durum Açıklaması", name: "durumAciklama", width: 150 },
        { header: "Özellik", name: "stokOzellikler", minWidth: 120 },
        { header: "Sipariş Evrak Numarası", name: "siparisEvrakNo", minWidth: 120 },
        { header: "Sipariş Kalem Numarası", name: "siparisKalemKodu", minWidth: 120 }
    ];

    // ----------------------------------
    // 4) GRID OLUŞTUR
    // ----------------------------------
    window.uretimGrid = liste_gridi_olustur("uretimGrid", tabloVerileri, tabloSutunlari, {
        filtreleme: true,
        siralama: true,
        excel: true,
        temizle: true,
        sutunSecimi: true,
        secim: true,  // üretimde seçim olmalı
        toplam: false,
        sabitKolonSayisi: 0,
        bodyHeight: 'fitToParent'
    });

});
</script>


<script>

// =============================================
// ÜRETİME GÖNDER → seçili satırlar yoksa uyar
// =============================================
function uretime_gonder() {
    const selectedRows = window.uretimGrid.getCheckedRows();

    if (!selectedRows || selectedRows.length === 0) {
        showToast("Lütfen en az bir satır seçin!", "warning");
        return;
    }

    // ❌ Durum=1 olmayan satır seçildiyse engelle
    const hataliSatir = selectedRows.find(r => r.durum !== 1);

    if (hataliSatir) {
        showToast(
            `Evrak No ${hataliSatir.evrakNo} olan satırın durumu '${hataliSatir.durum}'. 
            Sadece DURUM = 1 olan satırlar üretime gönderilebilir!`,
            "error"
        );
        return;
    }

    // ✔ Göndereceğimiz body
    const rows = selectedRows.map(r => ({
        evrakNo: r.evrakNo,
        stokKod: r.stokKod,
        stokAdi: r.stokAdi,
        planlananMiktar: r.planlananMiktar,
        birim: r.birim,
        durum: r.durum
    }));

    // AJAX → Backend
    fetch("/Uretim/UretimeGonder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(rows)
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            showToast(res.message, "success");
        } else {
            showToast(res.message, "error");
        }
    })
    .catch(err => {
        console.error("HATA:", err);
        showToast("Sunucuya bağlanılamadı!", "error");
    });
}




function is_emri_ciktisi_olustur() {
    const selectedRows = window.uretimGrid.getCheckedRows();

    if (!selectedRows || selectedRows.length === 0) {
        showToast("Lütfen en az bir satır seçin!", "warning");
        return;
    }

    const evraklar = selectedRows.map(r => r.evrakNo);

    console.log("PDF servisine giden evraklar:", evraklar);

    fetch("/Uretim/IsEmriCiktisiOlustur", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(evraklar)
    })
    .then(r => {
        if (!r.ok) throw new Error("Sunucu PDF oluşturamadı");
        return r.blob();  // PDF blob
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);

        // Yeni sekmede aç
        window.open(url, "_blank");

        showToast("PDF yeni sekmede açıldı.", "success");
    })
    .catch(err => {
        console.error(err);
        showToast("PDF oluşturulamadı!", "error");
    });
}






</script>

<script>
    $(document).ready(function() {
        $(".btn-erp-yeni").remove();
        $(".btn-erp-kaydet").remove();
        $(".btn-erp-guncelle").remove();        
    });
</script>

}
