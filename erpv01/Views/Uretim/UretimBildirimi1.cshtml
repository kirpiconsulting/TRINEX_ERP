@model List<erpv01.Controllers.UretimController.OperatorDto>

@{
    ViewData["Title"] = "Üretim Bildirme - 1";
    Layout = "_Layout";
}

<div class="container-fluid mt-3">

    <div class="row mb-3">

        <!-- 1. DEĞİŞİKLİK: Operatör Seçimi (Input Yapısı) -->
        <div class="col-12 col-md-4">
            <label class="fw-semibold mb-1">Operatör Kodu</label>
            <div class="input-group">
                <!-- Kod Giriş Alanı -->
                <input id="operatorInput" type="text" class="form-control" placeholder="Sicil No Girin ve Enter" />

                <!-- İsim Gösterge Alanı (Salt Okunur) -->
                <input id="operatorAdDisplay" type="text" class="form-control bg-light" readonly placeholder="Operatör Adı" />

                <!-- Temizle Butonu -->
                <button class="btn btn-outline-secondary" type="button" onclick="operatorTemizle()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <!-- İş Emri No -->
        <div class="col-12 col-md-4">
            <label class="fw-semibold mb-1">İş Emri No</label>
            <input id="isemriInput" type="text" class="form-control"
                   placeholder="Örn: 000123-00" />
        </div>
    </div>

    <div class="row">

        <!-- BEKLEYEN İŞ EMİRLERİ -->
        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header py-2">
                    <span class="fw-semibold">
                        <i class="fa-solid fa-list-check me-2"></i> Bekleyen İş Emirleri
                    </span>
                </div>
                <div class="card-body p-0">
                    <div id="bekleyenGrid" style="height: calc(100vh - 260px); width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- ÜRETİM BİLDİRİMİ -->
        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header py-2">
                    <span class="fw-semibold">
                        <i class="fa-solid fa-industry me-2"></i> Üretim Bildirimi
                    </span>
                </div>

                <div class="card-body small" id="uretimBildirimiContainer" style="display:flex; flex-direction:column; height: calc(100vh - 260px);">

                    <div id="seciliDetayBolumu">
                        <div id="seciliDetayBos" class="text-muted text-center mb-2">
                            Bekleyen iş emirlerinden bir satıra <b>çift tıklayın</b>
                        </div>

                        <div id="seciliDetayIcerik" style="display:none;">
                            <div class="mb-1">
                                <span class="fw-semibold">İş Emri No:</span>
                                <span id="d_isEmriNumarasi" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Kalem Kodu:</span>
                                <span id="d_kalemKodu" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Tezgah:</span>
                                <span id="d_tezgahAdi" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Başlangıç Tarihi:</span>
                                <span id="d_baslangicTarihi" class="ms-1"></span>
                            </div>
                            <hr class="my-2" />
                            <div class="mb-1">
                                <span class="fw-semibold">Stok Kodu:</span>
                                <span id="d_stokKodu" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Stok Adı:</span>
                                <span id="d_stokAdi" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Birim:</span>
                                <span id="d_birim" class="ms-1"></span>
                            </div>
                            <div class="mb-1">
                                <span class="fw-semibold">Stok Özellikler:</span>
                                <span id="d_stokOzellikler" class="ms-1"></span>
                            </div>
                        </div>
                    </div>

                    <div id="uretBilToolbar"
                         class="mt-2 d-flex justify-content-end gap-2"
                         style="display:none;">
                        @* Stokları Getir butonu artık otomatik çalışıyor, burası gizli kalabilir veya açılabilir *@
                    </div>

                    <div id="lotGridContainer" class="mt-2"
                         style="flex:1; min-height:200px; height:100%;"></div>

                    <div id="kaydet"
                         class="mt-2 d-flex justify-content-end gap-2"
                         style="display:none !important;">
                        <button type="button"
                                class="btn-erp-base"
                                onclick="btnKaydet()">
                            <i class="fa-solid fa-save me-1"></i> Kaydet
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- TAMAMLANAN İŞ EMİRLERİ -->
        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header py-2">
                    <span class="fw-semibold">
                        <i class="fa-solid fa-check-double me-2"></i> Tamamlanan İş Emirleri
                    </span>
                </div>
                <div class="card-body p-0">
                    <div id="tamamlananGrid"
                         style="height: calc(100vh - 260px); width: 100%;"></div>
                </div>
            </div>
        </div>

    </div>

</div>

@section Scripts {
    <script>
        // =========================================================
        // 1. GLOBAL DEĞİŞKENLER VE MODEL
        // =========================================================

        // Server tarafındaki operatör listesini JS değişkenine alıyoruz
        const operatorListesi = @Html.Raw(Json.Serialize(Model));

        let seciliIsEmriRow = null;
        let lotGrid = null;
        let bekleyenGrid = null;
        let tamamlananGrid = null;


        // =========================================================
        // 2. İŞ EMRİ ARAMA (ENTER İLE SEÇİM)
        // =========================================================
        document.getElementById("isemriInput").addEventListener("keyup", function (e) {
            var aranan = this.value.trim();
            if (!aranan) return;

            // Sadece ENTER tuşuna basıldığında işlem yap
            if (e.key === "Enter") {
                var rows = window.bekleyenGrid.getData();
                let bulunanIndex = -1;

                // Find ile ilk eşleşen kaydı bul (daha hızlı)
                const bulunanSatir = rows.find(row =>
                    row.isEmriNumarasi && row.isEmriNumarasi.toString().trim() === aranan.toString().trim()
                );

                if (bulunanSatir) {
                    bulunanIndex = bulunanSatir.rowKey;

                    // Satırı görsel olarak seç
                    window.bekleyenGrid.uncheckAll();
                    window.bekleyenGrid.check(bulunanIndex);
                    window.bekleyenGrid.focus(bulunanIndex, "isEmriNumarasi");

                    // Detay fonksiyonunu çağır
                    isemridetaygetir(bulunanIndex);

                    this.value = ""; // Inputu temizle
                    showToast("İş emri seçildi!", "success");
                } else {
                    showToast("İş emri listede bulunamadı!", "warning");
                }
            }
        });


        // =========================================================
        // 3. OPERATÖR İŞLEMLERİ (INPUT GİRİŞİ)
        // =========================================================

        // Operatör Input'u Enter Dinleme
        document.getElementById("operatorInput").addEventListener("keyup", function(e) {
            if (e.key !== "Enter") return; // Sadece Enter'da çalış

            const girilenKod = this.value.trim();
            if (!girilenKod) return;

            // JS listesinden operatörü bul (Büyük/küçük harf duyarsız)
            const bulunanOperator = operatorListesi.find(op =>
                op.kod && op.kod.toString().toLowerCase() === girilenKod.toLowerCase()
            );

            if (bulunanOperator) {
                // İsmi ekrana yaz
                document.getElementById("operatorAdDisplay").value = bulunanOperator.ad;

                // Tezgah verilerini parse et
                const tezgahStr = bulunanOperator.calisabilecegiTezgahlar || "";
                const tezgahlar = tezgahStr.split("|").map(x => x.trim()).filter(x => x.length > 0);

                // Verileri getir
                verileriGetir(girilenKod, tezgahlar);

            } else {
                showToast("Operatör bulunamadı!", "error");
                operatorTemizle(false); // False: inputu silme, diğerlerini temizle
            }
        });

        // Operatör Temizleme Butonu Fonksiyonu
        function operatorTemizle(inputuSil = true) {
            if(inputuSil) document.getElementById("operatorInput").value = "";
            document.getElementById("operatorAdDisplay").value = "";

            // Gridleri ve ekranı sıfırla
            if(window.bekleyenGrid) window.bekleyenGrid.resetData([]);
            if(window.tamamlananGrid) window.tamamlananGrid.resetData([]);

            // Detay ekranını sıfırla
            ekranSifirla();
        }

        // Ekranı resetleyen yardımcı fonksiyon
        function ekranSifirla() {
            seciliIsEmriRow = null;
            if (document.getElementById("seciliDetayBos"))
                document.getElementById("seciliDetayBos").style.display = "block";
            if (document.getElementById("seciliDetayIcerik"))
                document.getElementById("seciliDetayIcerik").style.display = "none";
            if (document.getElementById("uretBilToolbar"))
                document.getElementById("uretBilToolbar").style.display = "none";
            if (document.getElementById("kaydet"))
                document.getElementById("kaydet").style.setProperty("display", "none", "important");
            if (lotGrid) lotGrid.resetData([]);
        }

        // API'den Veri Çeken Fonksiyon
        function verileriGetir(opKod, tezgahlar) {
            if (tezgahlar.length === 0) {
                showToast("Bu operatör için tanımlı tezgah bulunamadı.", "warning");
                ekranSifirla();
                return;
            }

            // BEKLEYENLERİ ÇEK
            fetch("/Uretim/BekleyenIsEmirleri", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ operatorKod: opKod, tezgahlar: tezgahlar })
            })
            .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
            .then(res => {
                if (res.success) {
                    window.bekleyenGrid.resetData(res.data || []);
                    ekranSifirla(); // Yeni operatör gelince seçili detay temizlensin
                    if ((res.data || []).length === 0) showToast("Bekleyen iş emri yok.", "info");
                } else {
                    showToast(res.message, "error");
                    window.bekleyenGrid.resetData([]);
                }
            })
            .catch(err => console.error(err));

            // TAMAMLANANLARI ÇEK
            fetch("/Uretim/TamamlananIsEmirleri", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ operatorKod: opKod, tezgahlar: tezgahlar })
            })
            .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
            .then(res => {
                if (res.success) {
                    window.tamamlananGrid.resetData(res.data || []);
                }
            })
            .catch(err => console.error("Tamamlananlar hatası:", err));
        }


        // =========================================================
        // 4. STOKLARI GETİR (Otomatik Çağrılan)
        // =========================================================
        function btnStoklariGetirClick() {
            if (!seciliIsEmriRow) {
                // showToast("Lütfen önce bekleyen iş emirlerinden bir satıra çift tıklayın.", "warning");
                return;
            }

            const evrakNo   = seciliIsEmriRow.isEmriNumarasi;
            const tezgahKod = seciliIsEmriRow.tezgahKodu;

            if (!evrakNo || !tezgahKod) {
                console.log("Eksik bilgi:", { evrakNo, tezgahKod });
                showToast("Evrak no veya tezgah kodu bulunamadı.", "error");
                return;
            }

            fetch("/Uretim/StoklariGetir", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ evrakNo: evrakNo, tezgahKodu: tezgahKod })
            })
            .then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
            .then(res => {
                if (res.success !== true) {
                    showToast(res.message || "Stoklar getirilemedi!", "error");
                    if (lotGrid) lotGrid.resetData([]);
                    return;
                }

                const data = Array.isArray(res.data) ? res.data : [];

                if (!lotGrid) {
                    initLotGrid(data);
                } else {
                    lotGrid.resetData(data);
                }

                if(data.length > 0) {
                    showToast("Stoklar ve lotlar hesaplandı.", "success");
                    document.getElementById("kaydet").style.display = "flex";
                }
                else {
                    showToast("Bu tezgaha atanmış stok bulunamadı.", "info");
                    document.getElementById("kaydet").style.display = "flex";
                }
            })
            .catch(err => {
                console.error("Hata:", err);
                showToast("Sunucu hatası!", "error");
            });
        }


        // =========================================================
        // 5. DETAY GÖSTERME FONKSİYONU
        // =========================================================
        function isemridetaygetir(rowKey) {
             if (rowKey === undefined || rowKey === null) return;
                const row = window.bekleyenGrid.getRow(rowKey);
                if (!row) return;

                seciliIsEmriRow = row;

                const bos      = document.getElementById("seciliDetayBos");
                const icerik   = document.getElementById("seciliDetayIcerik");
                const toolbar  = document.getElementById("uretBilToolbar");
                const kaydetDiv = document.getElementById("kaydet");

                if (bos)     bos.style.display    = "none";
                if (icerik)  icerik.style.display = "block";
                if (toolbar) toolbar.style.display = "flex";

                if (kaydetDiv)
                    kaydetDiv.style.setProperty("display", "none", "important");

                document.getElementById("d_isEmriNumarasi").innerText  = row.isEmriNumarasi  || "";
                document.getElementById("d_kalemKodu").innerText       = row.kalemKodu       || "";
                document.getElementById("d_tezgahAdi").innerText       = row.tezgahAdi       || "";
                document.getElementById("d_baslangicTarihi").innerText = row.baslangicTarihi || "";
                document.getElementById("d_stokKodu").innerText        = row.stokKodu        || "";
                document.getElementById("d_stokAdi").innerText         = row.stokAdi         || "";
                document.getElementById("d_birim").innerText           = row.birim           || "";
                document.getElementById("d_stokOzellikler").innerText  = row.stokOzellikler  || "";

                if (lotGrid) lotGrid.resetData([]);

                // Otomatik olarak stokları getir
                btnStoklariGetirClick();
        }


        // =========================================================
        // 6. GRID OLUŞTURMA VE SAYFA YÜKLENMESİ
        // =========================================================

        // Lot Grid Yapılandırması
        function initLotGrid(initialData) {
            class SilButtonRenderer {
                constructor(props) {
                    const el = document.createElement("button");
                    el.type = "button";
                    el.className = "btn btn-sm btn-outline-danger border-0";
                    el.innerHTML = '<i class="fa-solid fa-trash"></i>';
                    el.onclick = (e) => { e.stopPropagation(); props.grid.removeRow(props.rowKey); };
                    this.el = el;
                }
                getElement() { return this.el; }
            }

            class KopyalaButtonRenderer {
                constructor(props) {
                    const el = document.createElement("button");
                    el.type = "button";
                    el.className = "btn btn-sm btn-outline-primary border-0 me-1";
                    el.innerHTML = '<i class="fa-solid fa-copy"></i>';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        const row = props.grid.getRow(props.rowKey);
                        props.grid.appendRow({
                            stokKodu: row.stokKodu,
                            stokAdi: row.stokAdi,
                            stokBirim: row.stokBirim,
                            depoKodu: row.depoKodu,
                            depoAdi: row.depoAdi,
                            lotKodu: "",
                            miktar: 0
                        }, { at: props.rowKey + 1 });
                    };
                    this.el = el;
                }
                getElement() { return this.el; }
            }

            class IslemlerRenderer {
                constructor(props) {
                    const div = document.createElement("div");
                    div.className = "text-center";
                    const btnKopyala = new KopyalaButtonRenderer(props).getElement();
                    const btnSil = new SilButtonRenderer(props).getElement();
                    div.appendChild(btnKopyala);
                    div.appendChild(btnSil);
                    this.el = div;
                }
                getElement() { return this.el; }
            }

            const lotKolonlar = [
                { header: "Stok Kodu",   name: "stokKodu",  width: 100 },
                { header: "Stok Adı",    name: "stokAdi",   minWidth: 150 },
                { header: "Stok Birim",  name: "stokBirim", minWidth: 80 },
                { header: "Depo Kodu",   name: "depoKodu",  width: 80 },
                { header: "Depo Adı",    name: "depoAdi",   minWidth: 100 },
                { header: "Lot No", name: "lotKodu", width: 120, editor: { type: "text" } },
                { header: "Miktar", name: "miktar", width: 90, align: "right", editor: { type: "text" } },
                { header: "İşlemler", name: "_islemler", width: 90, align: "center", renderer: { type: IslemlerRenderer } }
            ];

            lotGrid = liste_gridi_olustur("lotGridContainer", initialData, lotKolonlar, {
                filtreleme: false, siralama: false, temizle: false, bodyHeight: 100, secim: false, excel: false, sutunSecimi: false,
            });
        }

        // DOM Ready
        document.addEventListener("DOMContentLoaded", function () {

            // Bekleyen Grid
            const bekleyenKolonlar = [
                { header: "İş Emri No",  name: "isEmriNumarasi",  width: 120 },
                { header: "Marka",       name: "stokMarka",       width: 90 },
                { header: "Model",       name: "stokModel",       width: 90 }
            ];

            // Tamamlanan Grid
            const tamamlananKolonlar = [
                { header: "İş Emri No",  name: "isEmriNumarasi",  width: 120 },
                { header: "Marka",       name: "stokMarka",       width: 90 },
                { header: "Model",       name: "stokModel",       width: 90 }
            ];

            window.bekleyenGrid = liste_gridi_olustur("bekleyenGrid", [], bekleyenKolonlar, {
                filtreleme: true, siralama: true, temizle: true, sutunSecimi: true, bodyHeight: 'fitToParent', secim: false, excel: false,
            });

            window.tamamlananGrid = liste_gridi_olustur("tamamlananGrid", [], tamamlananKolonlar, {
                filtreleme: true, siralama: true, temizle: true, sutunSecimi: true, bodyHeight: 'fitToParent', secim: false, excel: false,
            });

            // Grid Çift Tıklama Eventi
            window.bekleyenGrid.on('dblclick', function (ev) {
               isemridetaygetir(ev.rowKey);
            });
        });


        // =========================================================
        // 7. KAYDETME İŞLEMİ
        // =========================================================
        function btnKaydet() {
            if (!lotGrid) {
                showToast("Lütfen önce işlem yapın.", "warning");
                return;
            }

            lotGrid.blur();

            const rawData = lotGrid.getData();
            const cleanData = rawData.map(satir => {
                let miktarStr = String(satir.miktar !== null && satir.miktar !== undefined ? satir.miktar : 0);
                miktarStr = miktarStr.replace(',', '.');
                let miktarSayi = parseFloat(miktarStr) || 0;

                return {
                    ...satir,
                    miktar: miktarSayi
                };
            });

            // 2. DEĞİŞİKLİK: Operatör kodunu artık Input'tan alıyoruz
            const operatorKod = document.getElementById("operatorInput").value;

            const baslikBilgisi = {
                IsEmriNo:        document.getElementById("d_isEmriNumarasi").innerText,
                KalemKodu:       document.getElementById("d_kalemKodu").innerText,
                TezgahAdi:       document.getElementById("d_tezgahAdi").innerText,
                BaslangicTarihi: document.getElementById("d_baslangicTarihi").innerText,
                UrunStokKodu:    document.getElementById("d_stokKodu").innerText,
                UrunStokAdi:     document.getElementById("d_stokAdi").innerText,
                UrunBirim:       document.getElementById("d_birim").innerText,
                UrunOzellikler:  document.getElementById("d_stokOzellikler").innerText,
                OperatorKod:     operatorKod
            };

            const gonderilecekPaket = {
                ...baslikBilgisi,
                Satirlar: cleanData
            };

            console.log("Sunucuya Giden Paket:", gonderilecekPaket);

            const btn = document.querySelector("#kaydet button");
            if(btn) btn.disabled = true;

            fetch('/Uretim/UretimBildirimiKaydet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gonderilecekPaket)
            })
            .then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
            .then(res => {
                if (res.success) {
                    showToast(res.message, "success");

                setTimeout(function () {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(res.message, "error");
                }
            })
            .catch(err => {
                console.error("Kaydet Hatası:", err);
                showToast("Sunucuyla iletişim hatası!", "error");
            })
            .finally(() => {
                if(btn) btn.disabled = false;
            });
        }
    </script>
}