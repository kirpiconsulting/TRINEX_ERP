@model List<erpv01.Controllers.SatisController.SatisKalemListeDto>

@{
    ViewData["Title"] = "Satış Siparişleri";
    Layout = "_Layout";
}


<style>
    /* İş emri açılmış satırlar için açık turuncu/sarı tonu */
    .tui-grid-row-is-emri-var {
        background-color: #ffeeba !important; 
        color: #856404 !important;
        font-weight: bold;
    }
    
    /* Hover olduğunda rengi bozulmasın istersen bunu da ekle */
    .tui-grid-row-is-emri-var:hover {
        background-color: #ffe8a1 !important;
    }
</style>





<div class="container-fluid mt-3 mb-3">

    <div class="row mb-2">
        <div class="col-12">
            <div id="listeToolbar"></div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div id="grid" style="height: calc(100vh - 180px); width: 100%;"></div>
        </div>
    </div>

    <!-- BURAYA EKLEYECEKSİN -->
    <div id="sonuc"
         class="mt-3 p-2 border rounded bg-light"
         style="display:none; white-space:pre;">
    </div>

</div>


<!-- İŞ EMRİ OLUŞTURMA MODALI (Sütun ayarları modalıyla aynı tasarım) -->
<div class="modal fade" id="isEmriModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">

            <!-- HEADER -->
            <div class="modal-header border-bottom-0 pb-1">
                <h6 class="modal-title fw-bold">
                    <i class="fa-solid fa-industry me-2"></i> İş Emirleri Oluştur
                </h6>

                <!-- Aynı sütun modalı gibi -->
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">
                <table class="table table-bordered table-sm" id="isEmriTable">
                    <thead class="table-light">
                        <tr>
                            <th>Evrak No</th>
                            <th>Kalem</th>
                            <th>Stok Kodu</th>
                            <th>Stok Adı</th>
                            <th>Birim</th>
                            <th>Miktar</th>
                            <th style="width:200px;">İş Emri Miktarı</th>
                            <th style="width:600px;">İş Emri Notu</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- FOOTER YOK -->

            <!-- ÜST BUTONLAR (footer yerine) -->
            <div class="px-3 pb-3 d-flex justify-content-end gap-2">

                <button type="button" class="btn-erp-base btn-erp-guncelle modalguncellebutton"
                        onclick="modal_is_emri_kaydet()">
                    <i class="fa-solid fa-check"></i> İş Emirlerini Oluştur
                </button>

                <button type="button" class="btn-erp-base" data-bs-dismiss="modal">
                    <i class="fa-solid fa-xmark"></i> Vazgeç
                </button>

            </div>

        </div>
    </div>
</div>



@section Scripts {
<script>

document.addEventListener("DOMContentLoaded", function () {

    // ---------------------------
    // 1) BUTONLAR (KALDI)
    // ---------------------------
    liste_ekrani_butonlari_olustur("listeToolbar", {
       fonksiyonlar: [
        { ad: "İş Emirlerini Oluştur", action: "is_emirlerini_olustur" },
        { ad: "Siparişleri Güncelle", action: "Siparis_Guncelle" }
    ]
   
    });

    // ---------------------------
    // 2) GERÇEK DATA (camelCase)
    // ---------------------------
    var tabloVerileri = @Html.Raw(
        System.Text.Json.JsonSerializer.Serialize(
            Model,
            new System.Text.Json.JsonSerializerOptions {
                PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
            }
        )
    );


    tabloVerileri.forEach(function(satir) {
    // Eğer Açılan İş Emri Miktarı 0'dan büyükse
        if (satir.acilanIsEmriMiktari > 0) {
            // O satıra özel class ekle (Toast UI Grid yapısına uygun)
            satir._attributes = {
                className: {
                    row: ['tui-grid-row-is-emri-var'] // Yukarıda yazdığımız CSS class adı
                }
            };
        }
    });

 

    // ---------------------------
    // 3) SÜTUNLAR (KALDI)
    // ---------------------------
    var tabloSutunlari = [
        { header: 'Evrak No', name: 'evrakNo', width: 100 },
        { header: 'Kalem No', name: 'kalemKodu', width: 80 },
        { header: 'Stok Kodu', name: 'stokKodu', width: 120 },
        { header: 'Stok Adı', name: 'stokAdi', minWidth: 250 },
        { header: 'Miktar', name: 'miktar', width: 80 },
        { header: 'Birim', name: 'birim', width: 80 },
        { header: 'Teslim Tarihi', name: 'teslimTarihi', width: 120 },
        { header: 'Açılan İş Emri Miktarı', name: 'acilanIsEmriMiktari', width: 120 }
    ];

    // ---------------------------
    // 4) GRIDİ OLUŞTUR
    // ---------------------------
    window.myGrid = liste_gridi_olustur("grid", tabloVerileri, tabloSutunlari, {
        filtreleme: true,
        siralama: true,
        excel: true,
        temizle: true,
        sutunSecimi: true,
        secim: true,
        toplam: false,
        sabitKolonSayisi: 0,
        bodyHeight: 'fitToParent'
    
    });

});

// Fonksiyonlar (Silmedim)
function btnYeniClick() { alert("Yeni"); }
function btnKaydetClick() { alert("Kaydet"); }





</script>



<script>
    function is_emirlerini_olustur() {
        const selectedRows = window.myGrid.getCheckedRows();

        if (!selectedRows || selectedRows.length === 0) {
            showToast("Lütfen en az bir satır seçin!", "warning");
            return;
        }

        console.log("Seçili Satırlar:", selectedRows);

        const tbody = document.querySelector("#isEmriTable tbody");
        tbody.innerHTML = "";

        selectedRows.forEach(row => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${row.evrakNo}</td>
                <td>${row.kalemKodu}</td>
                <td>${row.stokKodu}</td>
                <td>${row.stokAdi}</td>
                <td>${row.birim}</td>
                <td class="text-end">${row.miktar}</td>
                <td>
                    <input type="number" class="form-control form-control-sm is-emri-miktar"
                           value="${row.miktar}" min="0" step="0.01">
                </td>

                <td>
                    <input type="text" class="form-control form-control-sm is-emri-not"
                           >
                </td>
            `;

            tbody.appendChild(tr);
        });

        const modal = new bootstrap.Modal(document.getElementById('isEmriModal'));
        modal.show();
    }

  function Siparis_Guncelle() {

       showToast("Python script çalıştırılıyor...", "info");

        fetch('/Satis/PythonCalistir', {
            method: 'POST'
        })
        .then(r => r.text())
        .then(data => {
            if (data.startsWith("HATA")) {
                showToast(data, "error");
            } else {
                showToast(data, "success");
            }
        })
        .catch(err => {
            showToast("Hata: " + err, "error");
        });
    }


    function modal_is_emri_kaydet() {
    const rows = [];

    document.querySelectorAll("#isEmriTable tbody tr").forEach(tr => {
        rows.push({
            evrakNo: tr.cells[0].innerText.trim(),
            kalemKodu: tr.cells[1].innerText.trim(),
            stokKodu: tr.cells[2].innerText.trim(),
            stokAdi: tr.cells[3].innerText.trim(),
            birim: tr.cells[4].innerText.trim(),
            miktar: parseFloat(tr.cells[5].innerText.trim().replace(",", ".")),
            isEmriMiktar: parseFloat(tr.querySelector(".is-emri-miktar").value),
            isEmriNot: tr.querySelector(".is-emri-not").value
        });
    });

    console.log("Backend'e giden veri:", rows);

    // AJAX
    fetch("/Satis/IsEmirleriniOlustur", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(rows)
    })
    .then(r => r.json())
    .then(res => {

         let msg = res.message;

        if (res.warnings && res.warnings.length > 0) {
            msg += "\n\nUYARILAR:\n";   // alt başlık

            res.warnings.forEach(w => {
                msg += "- " + w + "\n"; // her uyarıyı ekle
            });
        }

        if (res.success === true) {
            // ✔ önce modalı kapatıyoruz
            const modal = bootstrap.Modal.getInstance(document.getElementById("isEmriModal"));
            modal.hide();

            // ✔ sonra başarı toast
            showToast(msg, "success");
        } else {
            // ❌ hata → modal kapanmaz
            showToast(msg, "error");
        }
    })
    .catch(err => {
        console.error("AJAX Hatası:", err);
        showToast("Sunucu ile iletişim sağlanamadı!", "error");
    });
}





</script>


<script>
    $(document).ready(function() {
        $(".btn-erp-yeni").remove();
        $(".btn-erp-kaydet").remove();
        $(".btn-erp-guncelle").not(".modalguncellebutton").remove();
        $(".btn-erp-sil").remove();
        $(".btn-erp-cikti").remove();


        
    });
</script>
}
